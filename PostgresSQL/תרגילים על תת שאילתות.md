# תרגילים על תת שאילתות – מסד נתונים Northwind

כל התרגילים דורשים שימוש **בתת שאילתות** לפתרון.  
בסוף המסמך – **פתרונות מלאים** באמצעות **CTE בלבד**.

---

## רמה 1: קל (תרגילים 1–6)

### תרגיל 1

הצג את כל המוצרים שמחירם **גבוה ממחירו הממוצע** של כל המוצרים במסד.

**רמז:** חשב קודם את המחיר הממוצע של כל המוצרים בשאילתה פנימית, והשווה אליו ב־WHERE.

---

### תרגיל 2

הצג את **שם החברה** של כל הלקוחות שלא ביצעו **אף הזמנה**.

**רמז:** השתמש ב־`customer_id` מתוך `orders` בתת שאילתה; הלקוחות המבוקשים הם אלה ש־`customer_id` שלהם **לא** מופיע שם.

---

### תרגיל 3

הצג את **שם המוצר** ו־**מחיר היחידה** של המוצרים ש־**מחירם הגבוה ביותר** בכל קטגוריה (בכל קטגוריה – רק המוצר היקר ביותר).

**רמז:** לכל קטגוריה חשב את `MAX(unit_price)`; חבר את התוצאה לטבלת המוצרים לפי `category_id` ומחיר.

---

### תרגיל 4

הצג את **שם העובד** (שם מלא: first_name + last_name) ואת **מספר ההזמנות** שהוא טיפל בהן, רק לעובדים שמספר ההזמנות שלהם **גבוה ממספר ההזמנות הממוצע** לכל עובד.

**רמז:** חשב קודם את ממוצע מספר ההזמנות לעובד; אחר כך סנן עובדים שמספר ההזמנות שלהם גדול מממוצע זה (באמצעות תת שאילתה או השוואה).

---

### תרגיל 5

הצג את **שם הקטגוריה** ואת **מספר המוצרים** בה, רק לקטגוריות שיש בהן **יותר מוצרים** ממספר המוצרים הממוצע בקטגוריה.

**רמז:** חשב ממוצע של מספר מוצרים לקטגוריה; סנן קטגוריות לפי `COUNT(*)` מול תת שאילתה שמחזירה את הממוצע.

---

### תרגיל 6

הצג את **שם המוצר** ואת **סה"כ הכמות שנמכרה** (מ־order_details) למוצרים ש־**סה"כ הכמות שנמכרה שלהם גבוהה מהממוצע** של סה"כ כמות שנמכרה לכל מוצר.

**רמז:** תת שאילתה אחת: סיכום כמות לפי מוצר וממוצע כללי; שאילתה חיצונית מסננת לפי מוצרים שמעל הממוצע.

---

## רמה 2: בינוני (תרגילים 7–13)

### תרגיל 7

הצג את **שם הלקוח** (company_name) ואת **מספר ההזמנות** שלו, רק ללקוחות ש־**מספר ההזמנות שלהם גדול מזה של כל הלקוחות ממדינת גרמניה (Germany)**.

**רמז:** בתת שאילתה מצא את `MAX` של מספר ההזמנות among לקוחות מ־Germany; בחוץ סנן לקוחות שמספר ההזמנות שלהם גדול מערך זה.

---

### תרגיל 8

הצג את **שם המוצר**, **מחיר היחידה** ו־**שם הקטגוריה** של מוצרים שמחירם **בטווח 10% מעל ומתחת למחיר החציון** של כל המוצרים (כלומר: מוצרים שמחירם בין 0.9×חציון ל־1.1×חציון).

**רמז:** השתמש ב־`PERCENTILE_CONT(0.5)` או בחישוב חציון ידני בתת שאילתה; השווה unit_price לטווח סביב החציון.

---

### תרגיל 9

הצג את **שם הספק** (company_name) ואת **מספר המוצרים** שהוא מספק, רק לספקים ש־**מספר המוצרים שלהם גדול ממספר המוצרים של הספק עם הכי מעט מוצרים** (כלומר גדול מהמינימום).

**רמז:** תת שאילתה: `MIN(COUNT(*))` לפי supplier (דרך GROUP BY ו־תת שאילתה); או מצא את ה־COUNT המינימלי ואז סנן ספקים שמעליו.

---

### תרגיל 10

הצג את **שם העובד** ואת **סכום ה־freight** של כל ההזמנות שהוא טיפל בהן, רק לעובדים ש־**סכום ה־freight הכולל שלהם גבוה מסכום ה־freight הכולל של העובד עם הסכום הנמוך ביותר**.

**רמז:** בדומה לתרגיל 9 – מצא את MIN של סה"כ freight לפי עובד, ואז הצג עובדים שמעליו.

---

### תרגיל 11

הצג את **שם המוצר** ו־**שם הקטגוריה** של מוצרים שנמכרו ב־**יותר מ־5 הזמנות שונות** (כלומר הופיעו ב־order_details עם יותר מ־5 order_id שונים).

**רמז:** תת שאילתה: מוצרים עם `COUNT(DISTINCT order_id) > 5` מ־order_details; חבר ל־products ו־categories.

---

### תרגיל 12

הצג את **שם הלקוח** ואת **תאריך ההזמנה הראשונה** שלו, רק ללקוחות ש־**ההזמנה הראשונה שלהם הייתה אחרי התאריך שבו בוצעה ההזמנה הראשונה במערכת** (כלומר אחרי MIN(order_date) הגלובלי).

**רמז:** חשב MIN(order_date) גלובלי; לכל לקוח חשב MIN(order_date); סנן לקוחות ש־MIN שלהם גדול מהמינימום הגלובלי.

---

### תרגיל 13

הצג את **שם המוצר**, **מחיר היחידה** ו־**שם הספק** של מוצרים ש־**מחירם גבוה ממחירו של כל מוצר בקטגוריה "Beverages"**.

**רמז:** תת שאילתה: MAX(unit_price) ממוצרים בקטגוריה Beverages (לפי category_id או category_name); הצג מוצרים ש־unit_price גדול מערך זה.

---

## רמה 3: קשה (תרגילים 14–20)

### תרגיל 14

הצג את **שם הלקוח** ואת **מספר ההזמנות** ו־**סכום ה־freight הכולל** שלו, רק ללקוחות ש־**ממוצע ה־freight להזמנה אצלם גבוה מממוצע ה־freight להזמנה של כל הלקוחות**.

**רמז:** חשב ממוצע גלובלי של freight להזמנה; לכל לקוח חשב ממוצע freight; השווה בתת שאילתה / ב־HAVING.

---

### תרגיל 15

הצג את **שם העובד** ואת **מספר ההזמנות** שלו, רק לעובדים ש־**מספר ההזמנות שלהם גדול ממספר ההזמנות של כל עובד הכפוף למנהל שלהם** (כלומר גדול מהמקסימום בקרב הכפופים לאותו reports_to).

**רמז:** לכל עובד חשב את MAX של מספר הזמנות among עובדים עם אותו reports_to; השווה את מספר ההזמנות של העובד ל־MAX הזה (רק לעובדים שיש להם כפופים).

---

### תרגיל 16

הצג את **שם הקטגוריה** ואת **סה"כ הכמות שנמכרה** מכל מוצריה (מ־order_details דרך products), רק לקטגוריות ש־**סה"כ הכמות שנמכרה בהן גדול מסה"כ הכמות שנמכרה בקטגוריה "Dairy Products"**.

**רמז:** תת שאילתה: סה"כ כמות ל־Dairy Products; לכל קטגוריה חשב סה"כ כמות והשווה.

---

### תרגיל 17

הצג את **שם הלקוח** ואת **מספר המוצרים השונים** שקנה (מספר product_id שונים ב־order_details דרך orders), רק ללקוחות ש־**מספר המוצרים השונים שקנו גדול ממספר המוצרים השונים שקנה הלקוח "Ernst Handel"**.

**רמז:** מצא את מספר המוצרים השונים ל־Ernst Handel; לכל לקוח חשב מספר מוצרים שונים והשווה.

---

### תרגיל 18

הצג את **שם המוצר** ו־**שם הקטגוריה** של מוצרים ש־**מחירם גבוה ממחיר הממוצע בקטגוריה שלהם** אך **נמוך ממחיר הממוצע של כל המוצרים במסד**.

**רמז:** שתי תת שאילתות (או אחת מורכבת): ממוצע לפי קטגוריה, וממוצע גלובלי; תנאי: unit_price בין שני הערכים.

---

### תרגיל 19

הצג את **שם הספק** ואת **מספר הלקוחות השונים** שקנו מוצרים שלו (דרך order_details → orders), רק לספקים ש־**מספר הלקוחות השונים אצלם גדול ממספר הלקוחות הממוצע** לכל ספק (ממוצע של "לקוחות שונים per ספק").

**רמז:** חשב לכל ספק COUNT(DISTINCT customer_id) דרך products → order_details → orders; חשב ממוצע של ערכים אלה; סנן ספקים שמעל הממוצע.

---

### תרגיל 20

הצג את **שם העובד**, **תאריך ההעסקה** (hire_date) ו־**מספר ההזמנות** שלו, רק לעובדים ש־**הועסקו אחרי כל העובדים שמספר ההזמנות שלהם נמוך ממספר ההזמנות הממוצע** (כלומר hire_date שלהם אחרי MAX(hire_date) של עובדים "מתחת לממוצע").

**רמז:** מצא ממוצע הזמנות לעובד; מצא את MAX(hire_date) among עובדים שמתחת לממוצע; הצג עובדים ש־hire_date גדול מתאריך זה.

---

# פתרונות (CTE בלבד)

## תרגיל 1

```sql
WITH avg_price AS (
    SELECT AVG(unit_price) AS avg_p
    FROM products
)
SELECT product_name, unit_price
FROM products, avg_price
WHERE products.unit_price > avg_price.avg_p;
```

---

## תרגיל 2

```sql
WITH customers_with_orders AS (
    SELECT DISTINCT customer_id FROM orders
)
SELECT company_name
FROM customers
WHERE customer_id NOT IN (SELECT customer_id FROM customers_with_orders);
```

---

## תרגיל 3

```sql
WITH max_price_per_category AS (
    SELECT category_id, MAX(unit_price) AS max_price
    FROM products
    GROUP BY category_id
)
SELECT p.product_name, p.unit_price
FROM products p
JOIN max_price_per_category m ON p.category_id = m.category_id AND p.unit_price = m.max_price;
```

---

## תרגיל 4

```sql
WITH orders_per_employee AS (
    SELECT employee_id, COUNT(*) AS order_count
    FROM orders
    GROUP BY employee_id
),
avg_orders AS (
    SELECT AVG(order_count) AS avg_c
    FROM orders_per_employee
)
SELECT e.first_name || ' ' || e.last_name AS employee_name, ope.order_count
FROM employees e
JOIN orders_per_employee ope ON e.employee_id = ope.employee_id
CROSS JOIN avg_orders
WHERE ope.order_count > avg_orders.avg_c;
```

---

## תרגיל 5

```sql
WITH products_per_category AS (
    SELECT category_id, COUNT(*) AS product_count
    FROM products
    GROUP BY category_id
),
avg_products AS (
    SELECT AVG(product_count) AS avg_c
    FROM products_per_category
)
SELECT c.category_name, ppc.product_count
FROM categories c
JOIN products_per_category ppc ON c.category_id = ppc.category_id
CROSS JOIN avg_products
WHERE ppc.product_count > avg_products.avg_c;
```

---

## תרגיל 6

```sql
WITH total_quantity_per_product AS (
    SELECT product_id, SUM(quantity) AS total_qty
    FROM order_details
    GROUP BY product_id
),
avg_quantity AS (
    SELECT AVG(total_qty) AS avg_q
    FROM total_quantity_per_product
)
SELECT p.product_name, tq.total_qty
FROM products p
JOIN total_quantity_per_product tq ON p.product_id = tq.product_id
CROSS JOIN avg_quantity
WHERE tq.total_qty > avg_quantity.avg_q;
```

---

## תרגיל 7

```sql
WITH orders_per_customer AS (
    SELECT customer_id, COUNT(*) AS order_count
    FROM orders
    GROUP BY customer_id
),
max_orders_germany AS (
    SELECT MAX(ope.order_count) AS max_g
    FROM orders_per_customer ope
    JOIN customers c ON ope.customer_id = c.customer_id
    WHERE c.country = 'Germany'
)
SELECT c.company_name, ope.order_count
FROM customers c
JOIN orders_per_customer ope ON c.customer_id = ope.customer_id
CROSS JOIN max_orders_germany
WHERE ope.order_count > max_orders_germany.max_g;
```

---

## תרגיל 8

```sql
WITH median_price AS (
    SELECT PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY unit_price) AS med
    FROM products
)
SELECT p.product_name, p.unit_price, c.category_name
FROM products p
JOIN categories c ON p.category_id = c.category_id
CROSS JOIN median_price mp
WHERE p.unit_price BETWEEN mp.med * 0.9 AND mp.med * 1.1;
```

---

## תרגיל 9

```sql
WITH products_per_supplier AS (
    SELECT supplier_id, COUNT(*) AS product_count
    FROM products
    GROUP BY supplier_id
),
min_products AS (
    SELECT MIN(product_count) AS min_c
    FROM products_per_supplier
)
SELECT s.company_name, pps.product_count
FROM suppliers s
JOIN products_per_supplier pps ON s.supplier_id = pps.supplier_id
CROSS JOIN min_products
WHERE pps.product_count > min_products.min_c;
```

---

## תרגיל 10

```sql
WITH freight_per_employee AS (
    SELECT employee_id, SUM(freight) AS total_freight
    FROM orders
    GROUP BY employee_id
),
min_freight AS (
    SELECT MIN(total_freight) AS min_f
    FROM freight_per_employee
)
SELECT e.first_name || ' ' || e.last_name AS employee_name, fpe.total_freight
FROM employees e
JOIN freight_per_employee fpe ON e.employee_id = fpe.employee_id
CROSS JOIN min_freight
WHERE fpe.total_freight > min_freight.min_f;
```

---

## תרגיל 11

```sql
WITH products_many_orders AS (
    SELECT product_id
    FROM order_details
    GROUP BY product_id
    HAVING COUNT(DISTINCT order_id) > 5
)
SELECT p.product_name, c.category_name
FROM products p
JOIN categories c ON p.category_id = c.category_id
WHERE p.product_id IN (SELECT product_id FROM products_many_orders);
```

---

## תרגיל 12

```sql
WITH first_order_global AS (
    SELECT MIN(order_date) AS first_date
    FROM orders
),
first_order_per_customer AS (
    SELECT customer_id, MIN(order_date) AS first_date
    FROM orders
    GROUP BY customer_id
)
SELECT c.company_name, foc.first_date
FROM customers c
JOIN first_order_per_customer foc ON c.customer_id = foc.customer_id
CROSS JOIN first_order_global fog
WHERE foc.first_date > fog.first_date;
```

---

## תרגיל 13

```sql
WITH max_beverages_price AS (
    SELECT MAX(p.unit_price) AS max_p
    FROM products p
    JOIN categories c ON p.category_id = c.category_id
    WHERE c.category_name = 'Beverages'
)
SELECT p.product_name, p.unit_price, s.company_name
FROM products p
JOIN suppliers s ON p.supplier_id = s.supplier_id
CROSS JOIN max_beverages_price mb
WHERE p.unit_price > mb.max_p;
```

---

## תרגיל 14

```sql
WITH avg_freight_global AS (
    SELECT AVG(freight) AS avg_f
    FROM orders
),
customer_orders_freight AS (
    SELECT customer_id, COUNT(*) AS order_count, SUM(freight) AS total_freight
    FROM orders
    GROUP BY customer_id
),
customer_avg_freight AS (
    SELECT customer_id, total_freight / order_count AS avg_freight
    FROM customer_orders_freight
)
SELECT c.company_name, cof.order_count, cof.total_freight
FROM customers c
JOIN customer_orders_freight cof ON c.customer_id = cof.customer_id
JOIN customer_avg_freight caf ON c.customer_id = caf.customer_id
CROSS JOIN avg_freight_global afg
WHERE caf.avg_freight > afg.avg_f;
```

---

## תרגיל 15

```sql
WITH orders_per_employee AS (
    SELECT employee_id, COUNT(*) AS order_count
    FROM orders
    GROUP BY employee_id
),
-- לכל עובד: מקסימום מספר הזמנות among עובדים אחרים עם אותו מנהל (reports_to)
max_other_per_employee AS (
    SELECT e1.employee_id AS emp_id, MAX(ope2.order_count) AS max_other
    FROM employees e1
    JOIN employees e2 ON e1.reports_to = e2.reports_to AND e1.employee_id <> e2.employee_id AND e1.reports_to IS NOT NULL
    JOIN orders_per_employee ope2 ON e2.employee_id = ope2.employee_id
    GROUP BY e1.employee_id
)
SELECT e.first_name || ' ' || e.last_name AS employee_name, ope.order_count
FROM employees e
JOIN orders_per_employee ope ON e.employee_id = ope.employee_id
JOIN max_other_per_employee mope ON e.employee_id = mope.emp_id
WHERE ope.order_count > mope.max_other;
```

---

## תרגיל 16

```sql
WITH quantity_per_category AS (
    SELECT p.category_id, SUM(od.quantity) AS total_qty
    FROM order_details od
    JOIN products p ON od.product_id = p.product_id
    GROUP BY p.category_id
),
dairy_total AS (
    SELECT qpc.total_qty AS dairy_qty
    FROM quantity_per_category qpc
    JOIN categories c ON qpc.category_id = c.category_id
    WHERE c.category_name = 'Dairy Products'
)
SELECT c.category_name, qpc.total_qty
FROM categories c
JOIN quantity_per_category qpc ON c.category_id = qpc.category_id
CROSS JOIN dairy_total dt
WHERE qpc.total_qty > dt.dairy_qty;
```

---

## תרגיל 17

```sql
WITH distinct_products_per_customer AS (
    SELECT o.customer_id, COUNT(DISTINCT od.product_id) AS product_count
    FROM orders o
    JOIN order_details od ON o.order_id = od.order_id
    GROUP BY o.customer_id
),
ernst_count AS (
    SELECT product_count AS ec
    FROM distinct_products_per_customer dppc
    JOIN customers c ON dppc.customer_id = c.customer_id
    WHERE c.company_name = 'Ernst Handel'
    LIMIT 1
)
SELECT c.company_name, dppc.product_count
FROM customers c
JOIN distinct_products_per_customer dppc ON c.customer_id = dppc.customer_id
CROSS JOIN ernst_count ec
WHERE dppc.product_count > ec.ec;
```

---

## תרגיל 18

```sql
WITH avg_by_category AS (
    SELECT category_id, AVG(unit_price) AS avg_cat
    FROM products
    GROUP BY category_id
),
avg_global AS (
    SELECT AVG(unit_price) AS avg_g
    FROM products
)
SELECT p.product_name, c.category_name
FROM products p
JOIN categories c ON p.category_id = c.category_id
JOIN avg_by_category abc ON p.category_id = abc.category_id
CROSS JOIN avg_global ag
WHERE p.unit_price > abc.avg_cat AND p.unit_price < ag.avg_g;
```

---

## תרגיל 19

```sql
WITH customers_per_supplier AS (
    SELECT p.supplier_id, COUNT(DISTINCT o.customer_id) AS customer_count
    FROM products p
    JOIN order_details od ON p.product_id = od.product_id
    JOIN orders o ON od.order_id = o.order_id
    GROUP BY p.supplier_id
),
avg_customers AS (
    SELECT AVG(customer_count) AS avg_c
    FROM customers_per_supplier
)
SELECT s.company_name, cps.customer_count
FROM suppliers s
JOIN customers_per_supplier cps ON s.supplier_id = cps.supplier_id
CROSS JOIN avg_customers ac
WHERE cps.customer_count > ac.avg_c;
```

---

## תרגיל 20

```sql
WITH orders_per_employee AS (
    SELECT employee_id, COUNT(*) AS order_count
    FROM orders
    GROUP BY employee_id
),
avg_orders AS (
    SELECT AVG(order_count) AS avg_c
    FROM orders_per_employee
),
below_avg_employees AS (
    SELECT ope.employee_id
    FROM orders_per_employee ope
    CROSS JOIN avg_orders ao
    WHERE ope.order_count < ao.avg_c
),
max_hire_below_avg AS (
    SELECT MAX(e.hire_date) AS max_hire
    FROM employees e
    WHERE e.employee_id IN (SELECT employee_id FROM below_avg_employees)
)
SELECT e.first_name || ' ' || e.last_name AS employee_name, e.hire_date, ope.order_count
FROM employees e
JOIN orders_per_employee ope ON e.employee_id = ope.employee_id
CROSS JOIN max_hire_below_avg mh
WHERE e.hire_date > mh.max_hire;
```

---

_סוף המסמך._
