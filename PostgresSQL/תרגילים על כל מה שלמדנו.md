# 20 תרגילים מאתגרים – Northwind (PostgreSQL)

**מסד נתונים:** Northwind  
**הגבלה:** ללא שימוש ב-Subqueries

כל התרגילים משלבים: SELECT, WHERE, JOIN, GROUP BY, HAVING, ORDER BY, LIMIT, פונקציות אגריגציה, פונקציות סקלר ואופרטורים.

---

## תרגיל 1
הצג את 5 הלקוחות הראשונים (לפי `company_name`) שמדינתם `'Germany'` או `'France'`, עם שם החברה באותיות גדולות (`UPPER`) והעיר באותיות קטנות (`LOWER`).

**עמודות להצגה:** `company_name` (UPPER), `city` (LOWER), `country`

---

## תרגיל 2
חשב לכל קטגוריה את מספר המוצרים, ממוצע המחיר וסכום ערך המלאי (`unit_price * units_in_stock`). הצג רק קטגוריות שיש בהן לפחות 4 מוצרים **וגם** ממוצע המחיר מעל 20. מיין לפי ממוצע המחיר יורד. הגבל ל-5 שורות.

**עמודות להצגה:** `category_name`, `product_count`, `avg_price`, `stock_value`

---

## תרגיל 3
הצג הזמנות עם: `order_id`, שם הלקוח, שם העובד (שרשור `first_name || ' ' || last_name`), תאריך ההזמנה – רק להזמנות מינואר או פברואר (השתמש ב-`EXTRACT(MONTH)`). מיין לפי תאריך עולה, הגבל ל-10 שורות.

**עמודות להצגה:** `order_id`, `company_name`, `employee_name` (שרשור), `order_date`

---

## תרגיל 4
חשב לכל מוצר את סך הכמות שנמכרה (`order_details`). חבר `products` ל-`order_details`. הצג `product_name`, `total_quantity` – רק למוצרים ששמם מכיל `'Ch'` או `'Co'` (LIKE). מיין לפי `total_quantity` יורד, הגבל ל-7 שורות.

**עמודות להצגה:** `product_name`, `total_quantity`

---

## תרגיל 5
חשב לכל לקוח את סך הערך הכולל של ההזמנות שלו (`quantity * unit_price * (1 - discount)` ב-`order_details`). חבר `customers`, `orders`, `order_details`. הצג `company_name`, `country`, `total_value` – רק ללקוחות מ-`'UK'` או `'USA'` שמסך ההזמנות שלהם מעל 5000. מיין לפי `total_value` יורד.

**עמודות להצגה:** `company_name`, `country`, `total_value`

---

## תרגיל 6
הצג את 3 המוצרים היקרים ביותר בכל קטגוריה. חשב ממוצע מחיר לכל קטגוריה, הצג קטגוריות שממוצע המחיר בהן בין 20 ל-60. הצג `category_name`, `avg_price` ממוין לפי ממוצע יורד, הגבל ל-3.

**עמודות להצגה:** `category_name`, `avg_price`

---

## תרגיל 7
חשב לכל עובד את מספר ההזמנות שביצע. חבר `employees` ל-`orders`. הצג `first_name`, `last_name`, `order_count` – רק לעובדים שביצעו בין 50 ל-150 הזמנות (כולל). מיין לפי `order_count` יורד.

**עמודות להצגה:** `first_name`, `last_name`, `order_count`

---

## תרגיל 8
הצג `product_name`, `unit_price`, אורך שם המוצר (`LENGTH(product_name)`) – למוצרים שמחירם מעל 30 **ו**-`units_in_stock` קטן מ-20. מיין לפי אורך השם יורד, הגבל ל-8 שורות.

**עמודות להצגה:** `product_name`, `unit_price`, `name_length` (LENGTH)

---

## תרגיל 9
חשב לכל ספק את מספר המוצרים והמחיר הממוצע. חבר `suppliers` ל-`products`. הצג `company_name`, `country`, `product_count`, `avg_price` – רק ספקים שיש להם לפחות 3 מוצרים **וגם** ממוצע המחיר של המוצרים שלהם מעל 25. מיין לפי `product_count` יורד.

**עמודות להצגה:** `company_name`, `country`, `product_count`, `avg_price`

---

## תרגיל 10
הצג `order_id`, `company_name`, `product_name`, כמות, מחיר, וערך שורה (`quantity * unit_price`). חבר 4 טבלאות. רק הזמנות משנת 1997 (EXTRACT) ומוצרים שמחירם מעל 40. מיין לפי ערך השורה יורד, הגבל ל-5 שורות.

**עמודות להצגה:** `order_id`, `company_name`, `product_name`, `quantity`, `unit_price`, `line_total`

---

## תרגיל 11
חשב לכל מדינה (מ-`customers`) את מספר הלקוחות ואת מספר ההזמנות. חבר `customers` ל-`orders`. הצג `country`, `customer_count`, `order_count` – רק מדינות שיש בהן לפחות 5 לקוחות. מיין לפי `order_count` יורד, הגבל ל-5 שורות.

**עמודות להצגה:** `country`, `customer_count`, `order_count`

**הערה:** השתמש ב-`COUNT(DISTINCT c.customer_id)` ו-`COUNT(o.order_id)` או דומה. קבוץ לפי `country`.

---

## תרגיל 12
הצג מוצרים עם `product_name`, `unit_price`, מחיר מעוגל ל-2 ספרות (`ROUND(unit_price, 2)`), ו-`COALESCE(quantity_per_unit, 'לא צוין')`. רק מוצרים שמחירם בין 10 ל-50 ושמם **לא** מכיל `'a'` (LIKE). מיין לפי מחיר עולה, הגבל ל-10.

**עמודות להצגה:** `product_name`, `unit_price`, `rounded_price`, `qty_per_unit`

---

## תרגיל 13
חשב לכל רבעון (EXTRACT QUARTER מ-`order_date`) את מספר ההזמנות ואת סכום ה-`freight` הכולל. הצג `year`, `quarter`, `order_count`, `total_freight` – רק רבעונים עם יותר מ-50 הזמנות. מיין לפי שנה ורבעון.

**עמודות להצגה:** `year`, `quarter`, `order_count`, `total_freight`

---

## תרגיל 14
הצג הזמנות עם שם הלקוח, שם החברה שמבצעת המשלוח (`shippers`), תאריך משלוח. חבר `orders`, `customers`, `shippers`. רק הזמנות ש-`shipped_date` אינו NULL ושה-`freight` מעל 50. מיין לפי `freight` יורד, הגבל ל-5.

**עמודות להצגה:** `order_id`, `company_name`, `shipper_name`, `shipped_date`, `freight`

---

## תרגיל 15
חשב לכל מוצר את סך הכמות שנמכרה וסך הערך (`quantity * unit_price`). חבר `products` ל-`order_details`, וגם ל-`categories`. הצג `category_name`, `product_name`, `total_quantity`, `total_value` – רק לקטגוריות "Beverages" או "Dairy Products", ורק מוצרים שנמכרו מעל 200 יחידות. מיין לפי `total_value` יורד, הגבל ל-10.

**עמודות להצגה:** `category_name`, `product_name`, `total_quantity`, `total_value`

---

## תרגיל 16
הצג `company_name`, `contact_name`, `LENGTH(contact_name)` – ללקוחות ש-`region` הוא NULL (השתמש ב-`IS NULL`). הצג גם `COALESCE(region, 'לא צוין')`. מיין לפי אורך שם המגע יורד, הגבל ל-8.

**עמודות להצגה:** `company_name`, `contact_name`, `name_length`, `region` (COALESCE)

---

## תרגיל 17
חשב לכל עובד את סך ערך ההזמנות שלו (חיבור `orders`, `order_details`, חישוב `quantity * unit_price * (1 - discount)`). הצג `first_name`, `last_name`, `total_sales` – רק לעובדים שסך המכירות שלהם בין 100000 ל-200000. מיין לפי `total_sales` יורד.

**עמודות להצגה:** `first_name`, `last_name`, `total_sales`

---

## תרגיל 18
הצג מוצרים עם `product_name`, `unit_price`, `units_in_stock`, ערך מלאי (`unit_price * units_in_stock`). רק מוצרים ש-`units_in_stock` בין 5 ל-30 **או** שמחירם מעל 80. הצג גם `discontinued` (0 או 1). מיין לפי ערך המלאי יורד, הגבל ל-10.

**עמודות להצגה:** `product_name`, `unit_price`, `units_in_stock`, `stock_value`, `discontinued`

---

## תרגיל 19
חשב לכל קטגוריה את מספר המוצרים הייחודיים ואת המחיר המקסימלי. הצג `category_name`, `product_count`, `max_price` – רק קטגוריות שיש בהן לפחות 5 מוצרים **וגם** מקסימום מחיר מעל 100. מיין לפי `max_price` יורד, הגבל ל-3.

**עמודות להצגה:** `category_name`, `product_count`, `max_price`

---

## תרגיל 20
הצג הזמנות עם `order_id`, `company_name`, שם העובד (שרשור), תאריך, שנה (`EXTRACT(YEAR)`), חודש (`EXTRACT(MONTH)`). חבר `orders`, `customers`, `employees`. רק הזמנות משנים 1996 או 1997, בחודשים 6–9 (יוני עד ספטמבר). מיין לפי תאריך עולה ואז לפי שם לקוח. הגבל ל-10 שורות.

**עמודות להצגה:** `order_id`, `company_name`, `employee_name` (שרשור), `order_date`, `year`, `month`

---

---

# פתרונות

<details>
<summary>לחץ כדי לראות את כל הפתרונות</summary>

## תרגיל 1
```sql
SELECT UPPER(company_name) AS company_name, LOWER(city) AS city, country
FROM customers
WHERE country IN ('Germany', 'France')
ORDER BY company_name
LIMIT 5;
```

## תרגיל 2
```sql
SELECT c.category_name, COUNT(*) AS product_count,
       AVG(p.unit_price) AS avg_price,
       SUM(p.unit_price * p.units_in_stock) AS stock_value
FROM products p
INNER JOIN categories c ON p.category_id = c.category_id
GROUP BY c.category_id, c.category_name
HAVING COUNT(*) >= 4 AND AVG(p.unit_price) > 20
ORDER BY avg_price DESC
LIMIT 5;
```

## תרגיל 3
```sql
SELECT o.order_id, c.company_name,
       e.first_name || ' ' || e.last_name AS employee_name,
       o.order_date
FROM orders o
INNER JOIN customers c ON o.customer_id = c.customer_id
INNER JOIN employees e ON o.employee_id = e.employee_id
WHERE EXTRACT(MONTH FROM o.order_date) IN (1, 2)
ORDER BY o.order_date
LIMIT 10;
```

## תרגיל 4
```sql
SELECT p.product_name, SUM(od.quantity) AS total_quantity
FROM products p
INNER JOIN order_details od ON p.product_id = od.product_id
WHERE p.product_name LIKE '%Ch%' OR p.product_name LIKE '%Co%'
GROUP BY p.product_id, p.product_name
ORDER BY total_quantity DESC
LIMIT 7;
```

## תרגיל 5
```sql
SELECT c.company_name, c.country,
       SUM(od.quantity * od.unit_price * (1 - od.discount)) AS total_value
FROM customers c
INNER JOIN orders o ON c.customer_id = o.customer_id
INNER JOIN order_details od ON o.order_id = od.order_id
WHERE c.country IN ('UK', 'USA')
GROUP BY c.customer_id, c.company_name, c.country
HAVING SUM(od.quantity * od.unit_price * (1 - od.discount)) > 5000
ORDER BY total_value DESC;
```

## תרגיל 6
```sql
SELECT c.category_name, AVG(p.unit_price) AS avg_price
FROM products p
INNER JOIN categories c ON p.category_id = c.category_id
GROUP BY c.category_id, c.category_name
HAVING AVG(p.unit_price) BETWEEN 20 AND 60
ORDER BY avg_price DESC
LIMIT 3;
```

## תרגיל 7
```sql
SELECT e.first_name, e.last_name, COUNT(o.order_id) AS order_count
FROM employees e
INNER JOIN orders o ON e.employee_id = o.employee_id
GROUP BY e.employee_id, e.first_name, e.last_name
HAVING COUNT(o.order_id) BETWEEN 50 AND 150
ORDER BY order_count DESC;
```

## תרגיל 8
```sql
SELECT product_name, unit_price, LENGTH(product_name) AS name_length
FROM products
WHERE unit_price > 30 AND units_in_stock < 20
ORDER BY name_length DESC
LIMIT 8;
```

## תרגיל 9
```sql
SELECT s.company_name, s.country, COUNT(p.product_id) AS product_count,
       AVG(p.unit_price) AS avg_price
FROM suppliers s
INNER JOIN products p ON s.supplier_id = p.supplier_id
GROUP BY s.supplier_id, s.company_name, s.country
HAVING COUNT(p.product_id) >= 3 AND AVG(p.unit_price) > 25
ORDER BY product_count DESC;
```

## תרגיל 10
```sql
SELECT o.order_id, c.company_name, p.product_name,
       od.quantity, od.unit_price,
       od.quantity * od.unit_price AS line_total
FROM orders o
INNER JOIN customers c ON o.customer_id = c.customer_id
INNER JOIN order_details od ON o.order_id = od.order_id
INNER JOIN products p ON od.product_id = p.product_id
WHERE EXTRACT(YEAR FROM o.order_date) = 1997 AND od.unit_price > 40
ORDER BY line_total DESC
LIMIT 5;
```

## תרגיל 11
```sql
SELECT c.country,
       COUNT(DISTINCT c.customer_id) AS customer_count,
       COUNT(o.order_id) AS order_count
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.country
HAVING COUNT(DISTINCT c.customer_id) >= 5
ORDER BY order_count DESC
LIMIT 5;
```

## תרגיל 12
```sql
SELECT product_name, unit_price,
       ROUND(unit_price, 2) AS rounded_price,
       COALESCE(quantity_per_unit, 'לא צוין') AS qty_per_unit
FROM products
WHERE unit_price BETWEEN 10 AND 50
  AND product_name NOT LIKE '%a%'
ORDER BY unit_price
LIMIT 10;
```

## תרגיל 13
```sql
SELECT EXTRACT(YEAR FROM order_date) AS year,
       EXTRACT(QUARTER FROM order_date) AS quarter,
       COUNT(*) AS order_count,
       SUM(freight) AS total_freight
FROM orders
GROUP BY EXTRACT(YEAR FROM order_date), EXTRACT(QUARTER FROM order_date)
HAVING COUNT(*) > 50
ORDER BY year, quarter;
```

## תרגיל 14
```sql
SELECT o.order_id, c.company_name, sh.company_name AS shipper_name,
       o.shipped_date, o.freight
FROM orders o
INNER JOIN customers c ON o.customer_id = c.customer_id
INNER JOIN shippers sh ON o.ship_via = sh.shipper_id
WHERE o.shipped_date IS NOT NULL AND o.freight > 50
ORDER BY o.freight DESC
LIMIT 5;
```

## תרגיל 15
```sql
SELECT cat.category_name, p.product_name,
       SUM(od.quantity) AS total_quantity,
       SUM(od.quantity * od.unit_price) AS total_value
FROM products p
INNER JOIN order_details od ON p.product_id = od.product_id
INNER JOIN categories cat ON p.category_id = cat.category_id
WHERE cat.category_name IN ('Beverages', 'Dairy Products')
GROUP BY cat.category_id, cat.category_name, p.product_id, p.product_name
HAVING SUM(od.quantity) > 200
ORDER BY total_value DESC
LIMIT 10;
```

## תרגיל 16
```sql
SELECT company_name, contact_name,
       LENGTH(contact_name) AS name_length,
       COALESCE(region, 'לא צוין') AS region
FROM customers
WHERE region IS NULL
ORDER BY name_length DESC
LIMIT 8;
```

## תרגיל 17
```sql
SELECT e.first_name, e.last_name,
       SUM(od.quantity * od.unit_price * (1 - od.discount)) AS total_sales
FROM employees e
INNER JOIN orders o ON e.employee_id = o.employee_id
INNER JOIN order_details od ON o.order_id = od.order_id
GROUP BY e.employee_id, e.first_name, e.last_name
HAVING SUM(od.quantity * od.unit_price * (1 - od.discount)) BETWEEN 100000 AND 200000
ORDER BY total_sales DESC;
```

## תרגיל 18
```sql
SELECT product_name, unit_price, units_in_stock,
       unit_price * units_in_stock AS stock_value,
       discontinued
FROM products
WHERE (units_in_stock BETWEEN 5 AND 30) OR unit_price > 80
ORDER BY stock_value DESC
LIMIT 10;
```

## תרגיל 19
```sql
SELECT c.category_name, COUNT(*) AS product_count,
       MAX(p.unit_price) AS max_price
FROM products p
INNER JOIN categories c ON p.category_id = c.category_id
GROUP BY c.category_id, c.category_name
HAVING COUNT(*) >= 5 AND MAX(p.unit_price) > 100
ORDER BY max_price DESC
LIMIT 3;
```

## תרגיל 20
```sql
SELECT o.order_id, c.company_name,
       e.first_name || ' ' || e.last_name AS employee_name,
       o.order_date,
       EXTRACT(YEAR FROM o.order_date) AS year,
       EXTRACT(MONTH FROM o.order_date) AS month
FROM orders o
INNER JOIN customers c ON o.customer_id = c.customer_id
INNER JOIN employees e ON o.employee_id = e.employee_id
WHERE EXTRACT(YEAR FROM o.order_date) IN (1996, 1997)
  AND EXTRACT(MONTH FROM o.order_date) BETWEEN 6 AND 9
ORDER BY o.order_date, c.company_name
LIMIT 10;
```

</details>
